# 🔐 會員系統設置指南

## 📋 系統概述

已實作完整的會員系統，支援：
- ✅ Email 註冊/登入
- ✅ Google OAuth 登入
- ✅ Email 驗證
- ✅ Session 管理
- ✅ 設備追蹤
- ✅ 兌換碼綁定到用戶

---

## 🗄️ 數據庫設置

### 步驟 1：初始化會員系統數據庫

```bash
cd /Users/yen-tangchang/Documents/github/FAE/APCS/workers

# 執行會員系統 schema
wrangler d1 execute apcs-course-db --remote --file=schema-auth.sql
```

這將創建以下表：
- `users` - 用戶資料
- `user_redemptions` - 用戶兌換記錄
- `user_devices` - 用戶設備
- `sessions` - 登入會話
- `email_verifications` - Email 驗證碼

---

## 🔑 Google OAuth 設置

### 步驟 1：創建 Google Cloud 專案

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 創建新專案或選擇現有專案
3. 專案名稱：`APCS Space Course`

### 步驟 2：啟用 Google+ API

1. 在左側選單選擇「API 和服務」→「資料庫」
2. 點擊「+ 啟用 API 和服務」
3. 搜尋「Google+ API」
4. 點擊「啟用」

### 步驟 3：創建 OAuth 2.0 憑證

1. 在左側選單選擇「API 和服務」→「憑證」
2. 點擊「+ 建立憑證」→「OAuth 用戶端 ID」
3. 應用程式類型：「網頁應用程式」
4. 名稱：`APCS Auth`

5. **已授權的 JavaScript 來源**：
   ```
   http://localhost:8000
   https://apcs-space-course.pages.dev
   https://apcs-auth-api.589411.workers.dev
   ```

6. **已授權的重新導向 URI**：
   ```
   http://localhost:8000/auth-success.html
   https://apcs-space-course.pages.dev/auth-success.html
   https://apcs-auth-api.589411.workers.dev/api/auth/google/callback
   ```

7. 點擊「建立」
8. **記下 Client ID 和 Client Secret**

### 步驟 4：設置 Cloudflare Secrets

```bash
cd /Users/yen-tangchang/Documents/github/FAE/APCS/workers

# 設置 Google Client ID
wrangler secret put GOOGLE_CLIENT_ID
# 貼上你的 Client ID

# 設置 Google Client Secret
wrangler secret put GOOGLE_CLIENT_SECRET
# 貼上你的 Client Secret
```

---

## 🚀 部署

### 步驟 1：初始化數據庫

```bash
# 執行會員系統 schema
wrangler d1 execute apcs-course-db --remote --file=schema-auth.sql
```

### 步驟 2：部署 Worker

```bash
wrangler deploy
```

### 步驟 3：驗證部署

```bash
# 測試健康檢查
curl https://apcs-auth-api.589411.workers.dev/api/health
```

---

## 📡 API 端點

### 認證相關

| 端點 | 方法 | 功能 | 參數 |
|------|------|------|------|
| `/api/auth/register` | POST | Email 註冊 | `{email, password, name}` |
| `/api/auth/login` | POST | Email 登入 | `{email, password, deviceId}` |
| `/api/auth/verify-email` | POST | 驗證 Email | `{email, code}` |
| `/api/auth/google/login` | GET | Google 登入 | - |
| `/api/auth/google/callback` | GET | Google 回調 | `code, state` |

### 兌換碼相關（已更新）

| 端點 | 方法 | 功能 | 需要登入 |
|------|------|------|----------|
| `/api/validate-code` | POST | 驗證兌換碼 | ✅ |
| `/api/check-lesson` | POST | 檢查課程訪問 | ✅ |

---

## 🧪 測試流程

### 測試 Email 註冊

```bash
curl -X POST https://apcs-auth-api.589411.workers.dev/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123",
    "name": "測試用戶"
  }'
```

**預期響應**：
```json
{
  "success": true,
  "message": "註冊成功！請查收驗證 Email",
  "userId": 1,
  "verificationCode": "123456"
}
```

### 測試 Email 驗證

```bash
curl -X POST https://apcs-auth-api.589411.workers.dev/api/auth/verify-email \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "code": "123456"
  }'
```

### 測試登入

```bash
curl -X POST https://apcs-auth-api.589411.workers.dev/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123",
    "deviceId": "dev_test_device1"
  }'
```

**預期響應**：
```json
{
  "success": true,
  "message": "登入成功",
  "sessionToken": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "user": {
    "id": 1,
    "email": "test@example.com",
    "name": "測試用戶"
  }
}
```

---

## 🎨 前端整合

### 下一步需要創建的頁面：

1. **登入/註冊頁面** (`login.html`)
   - Email 註冊表單
   - Email 登入表單
   - Google 登入按鈕
   - Email 驗證輸入

2. **OAuth 成功頁面** (`auth-success.html`)
   - 接收 Google OAuth 回調
   - 存儲 session token
   - 重定向到儀表板

3. **用戶儀表板** (`dashboard.html`)
   - 顯示用戶資訊
   - 兌換碼輸入
   - 設備管理
   - 課程訪問狀態

4. **設備管理頁面** (`devices.html`)
   - 列出所有設備
   - 移除設備
   - 重命名設備

---

## 🔄 完整用戶流程

### 新用戶註冊流程

```
1. 訪問 login.html
2. 選擇註冊方式：
   
   方式 A - Email 註冊：
   ├─ 輸入 Email、密碼、姓名
   ├─ 提交註冊
   ├─ 收到驗證碼（開發環境顯示在響應中）
   ├─ 輸入驗證碼
   ├─ Email 驗證成功
   └─ 自動登入 → 跳轉到儀表板
   
   方式 B - Google 登入：
   ├─ 點擊「使用 Google 登入」
   ├─ 重定向到 Google
   ├─ 授權後返回
   ├─ 自動創建帳號
   └─ 跳轉到儀表板

3. 在儀表板輸入兌換碼
4. 兌換成功 → 綁定到用戶帳號
5. 可以訪問所有付費課程
```

### 現有用戶登入流程

```
1. 訪問 login.html
2. 選擇登入方式：
   
   方式 A - Email 登入：
   ├─ 輸入 Email、密碼
   ├─ 提交登入
   └─ 跳轉到儀表板
   
   方式 B - Google 登入：
   ├─ 點擊「使用 Google 登入」
   ├─ 重定向到 Google
   └─ 授權後返回儀表板

3. 查看已兌換的課程
4. 管理設備
5. 訪問課程
```

---

## 🔐 安全性特性

### 已實作

- ✅ 密碼 Hash（SHA-256 + Salt）
- ✅ Session Token（UUID）
- ✅ Email 驗證
- ✅ 設備追蹤
- ✅ IP 記錄
- ✅ Session 過期（30天）
- ✅ 驗證碼過期（30分鐘）

### 建議增強（未來）

- [ ] 密碼強度檢查
- [ ] 登入失敗次數限制
- [ ] 雙因素認證（2FA）
- [ ] 可疑登入警告
- [ ] Session 刷新機制

---

## 📊 數據庫查詢範例

### 查看所有用戶

```sql
SELECT id, email, name, email_verified, created_at, last_login 
FROM users 
WHERE status = 'active' 
ORDER BY created_at DESC;
```

### 查看用戶的兌換記錄

```sql
SELECT ur.*, rc.plan 
FROM user_redemptions ur
JOIN redemption_codes rc ON ur.redemption_code_id = rc.id
WHERE ur.user_id = ? AND ur.status = 'active';
```

### 查看用戶的設備

```sql
SELECT * FROM user_devices 
WHERE user_id = ? AND status = 'active' 
ORDER BY last_seen DESC;
```

### 查看活躍 Session

```sql
SELECT s.*, u.email 
FROM sessions s
JOIN users u ON s.user_id = u.id
WHERE s.expires_at > datetime('now')
ORDER BY s.last_activity DESC;
```

---

## 🎯 下一步

1. ✅ 數據庫結構設計完成
2. ✅ Worker API 實作完成
3. ⏳ 創建前端登入/註冊頁面
4. ⏳ 創建用戶儀表板
5. ⏳ 整合 Google OAuth
6. ⏳ 測試完整流程
7. ⏳ 部署到生產環境

---

**當前狀態**: 後端 API 已完成，等待前端頁面開發

**預計完成時間**: 1-2 小時（包含前端開發和測試）
