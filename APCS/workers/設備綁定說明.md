# 🔒 設備綁定系統說明

## 📋 實作概述

已實作**方案 1 + 3**：Token 不含兌換碼 + 綁定設備指紋

---

## 🎯 核心特性

### 1. Token 不包含兌換碼 ✅
- Token 中只包含隨機生成的 `tokenId`
- 兌換碼存儲在服務器端（Cloudflare KV）
- 即使 Token 被解碼，也看不到原始兌換碼

**Token 內容示例**：
```json
{
  "tokenId": "550e8400-e29b-41d4-a716-446655440000",
  "deviceId": "dev_abc123xyz",
  "timestamp": 1762088768332,
  "random": "hhj0pzgarop"
}
```

### 2. 設備指紋綁定 ✅
- 自動生成設備指紋（基於瀏覽器特徵）
- 每個設備有唯一的 `deviceId`
- Token 綁定特定設備

**設備指紋組成**：
- User Agent
- 語言設置
- 螢幕解析度
- 時區偏移
- CPU 核心數
- 平台信息

### 3. 多設備支持 ✅
- 預設允許最多 **3 台設備**
- 自動追蹤已授權設備列表
- 達到上限後拒絕新設備

---

## 🔐 安全性提升

### 之前的問題 ❌
```javascript
// 舊 Token 可以直接解碼看到兌換碼
const token = "eyJjb2RlIjoiQVBDUzIwMjQtVEVTVDAxIi...";
console.log(atob(token.split('.')[0]));
// 輸出：{"code":"APCS2024-TEST01",...}  ⚠️ 兌換碼暴露
```

### 現在的保護 ✅
```javascript
// 新 Token 只包含 tokenId
const token = "eyJ0b2tlbklkIjoiNTUwZTg0MDAtZTI5Yi00MWQ0...";
console.log(atob(token.split('.')[0]));
// 輸出：{"tokenId":"550e8400-e29b-41d4-a716-446655440000",...}  ✅ 看不到兌換碼
```

---

## 📊 工作流程

### 兌換流程

```
用戶輸入兌換碼
    ↓
前端生成設備指紋 (deviceId)
    ↓
發送到 API: {code, deviceId}
    ↓
API 驗證兌換碼
    ↓
生成 tokenId (UUID)
    ↓
生成 Token (包含 tokenId + deviceId)
    ↓
存儲到 KV: {
  code: "APCS2024-XXX",  ← 兌換碼存服務器
  devices: ["dev_abc123"],
  maxDevices: 3
}
    ↓
返回 Token 給前端
    ↓
前端存儲: localStorage
```

### 訪問課程流程

```
用戶訪問課程
    ↓
前端發送: {token, tokenId, deviceId, lessonId}
    ↓
API 驗證 Token 簽名
    ↓
檢查 deviceId 是否匹配
    ↓
從 KV 獲取訪問數據
    ↓
檢查設備是否已授權
    ↓
如果是新設備 && 未達上限
    → 添加到設備列表
    ↓
如果是新設備 && 已達上限
    → 拒絕訪問
    ↓
記錄訪問日誌
    ↓
返回訪問結果
```

---

## 🗄️ 數據結構

### D1 數據庫

```sql
CREATE TABLE redemption_codes (
    id INTEGER PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,
    plan TEXT NOT NULL,
    used INTEGER DEFAULT 0,
    created_at TEXT,
    used_at TEXT,
    user_ip TEXT,
    user_email TEXT,
    device_id TEXT,          -- 首次使用的設備
    max_devices INTEGER DEFAULT 3  -- 允許的最大設備數
);
```

### KV 存儲

```json
{
  "key": "token:550e8400-e29b-41d4-a716-446655440000",
  "value": {
    "code": "APCS2024-TEST01",
    "devices": [
      "dev_abc123xyz",
      "dev_def456uvw"
    ],
    "maxDevices": 3,
    "unlocked": true,
    "timestamp": 1762088768332,
    "expiresAt": 1793624768332
  }
}
```

---

## 🎮 使用示例

### 前端兌換

```javascript
// 自動生成設備指紋
const api = new CourseAPI();
console.log('設備 ID:', api.deviceId);  // dev_abc123xyz

// 兌換碼
const result = await api.validateCode('APCS2024-TEST01');
if (result.success) {
    console.log('解鎖成功！');
    console.log('Token:', api.token);
    console.log('TokenId:', api.tokenId);
}
```

### 檢查課程訪問

```javascript
const canAccess = await api.checkLessonAccess('B1');
if (canAccess) {
    console.log('可以訪問課程 B1');
} else {
    console.log('無法訪問，可能達到設備數限制');
}
```

---

## 🔧 配置選項

### 調整最大設備數

**方法 1：在數據庫中設置**
```sql
-- 為特定兌換碼設置不同的設備數限制
UPDATE redemption_codes 
SET max_devices = 5 
WHERE code = 'APCS2024-VIP01';
```

**方法 2：在插入時指定**
```sql
INSERT INTO redemption_codes (code, plan, max_devices) 
VALUES ('APCS2024-PREMIUM', 'full', 10);
```

---

## 🛡️ 安全特性

### 1. Token 簽名驗證
- 使用 HMAC-SHA256 簽名
- 防止 Token 偽造
- 需要 `JWT_SECRET` 才能生成有效簽名

### 2. 設備綁定
- Token 綁定特定設備
- 在其他設備使用會被拒絕
- 自動追蹤設備列表

### 3. 設備數量限制
- 預設最多 3 台設備
- 達到上限自動拒絕
- 可針對不同方案設置不同限制

### 4. 訪問日誌
- 記錄所有訪問行為
- 包含 IP、User Agent
- 便於審計和分析

---

## 📈 優勢

### 用戶體驗 ✅
- 可在多台設備學習（學校、家裡、圖書館）
- 自動設備管理，無需手動操作
- 達到限制時有明確提示

### 安全性 ✅
- 兌換碼不可見
- 防止隨意分享
- 設備綁定防濫用

### 靈活性 ✅
- 可調整設備數限制
- 支持不同方案（早鳥、完整）
- 易於擴展

---

## 🧪 測試

### 測試兌換碼

```bash
# 使用新的兌換碼（需要提供 deviceId）
curl -X POST https://apcs-auth-api.589411.workers.dev/api/validate-code \
  -H "Content-Type: application/json" \
  -d '{
    "code": "APCS2024-DEMO01",
    "deviceId": "dev_test123"
  }'
```

### 測試課程訪問

```bash
# 需要提供 token, tokenId, deviceId
curl -X POST https://apcs-auth-api.589411.workers.dev/api/check-lesson \
  -H "Content-Type: application/json" \
  -d '{
    "token": "eyJ0b2tlbklkIjoiNTUwZTg0MDAtZTI5Yi00MWQ0...",
    "tokenId": "550e8400-e29b-41d4-a716-446655440000",
    "deviceId": "dev_test123",
    "lessonId": "B1"
  }'
```

---

## 🔄 遷移指南

### 現有用戶

如果有現有用戶使用舊版 Token：

1. **自動遷移**：舊 Token 仍可使用，但會在下次兌換時升級
2. **手動遷移**：清除 localStorage，重新兌換

```javascript
// 清除舊數據
localStorage.clear();

// 重新兌換
const api = new CourseAPI();
await api.validateCode('YOUR-CODE');
```

---

## 📞 常見問題

### Q: 如果換了瀏覽器怎麼辦？
A: 會被視為新設備，只要未達到設備數上限，會自動添加到授權列表。

### Q: 如果達到設備數上限？
A: 會顯示錯誤訊息，無法在新設備使用。需要聯繫客服解除綁定。

### Q: 設備指紋會改變嗎？
A: 正常情況下不會。除非更改螢幕解析度、瀏覽器等重大設置。

### Q: 可以手動解除設備綁定嗎？
A: 目前需要通過後台操作。未來可以添加用戶自助解綁功能。

---

## 🚀 部署步驟

1. **更新數據庫**
```bash
cd /Users/yen-tangchang/Documents/github/FAE/APCS/workers
wrangler d1 execute apcs-course-db --remote --command="
ALTER TABLE redemption_codes ADD COLUMN device_id TEXT;
ALTER TABLE redemption_codes ADD COLUMN max_devices INTEGER DEFAULT 3;
"
```

2. **部署 Worker**
```bash
wrangler deploy
```

3. **部署前端**
```bash
# 提交到 Git
git add .
git commit -m "feat: 實作設備綁定系統"
git push

# Cloudflare Pages 會自動部署
```

---

**實作完成時間**: 2025-11-02  
**版本**: v2.0.0  
**狀態**: ✅ 準備部署
