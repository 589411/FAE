# 🧪 會員系統整合測試指南

## 📋 已完成的功能

### ✅ 後端 API（auth-api.js）
1. **會員兌換課程碼** - `/api/auth/redeem-code`
2. **查詢我的課程** - `/api/auth/my-courses`
3. **驗證 Session Token** - `/api/auth/verify-session`
4. **課程訪問權限檢查** - `/api/check-lesson`（已整合會員系統）

### ✅ 前端功能
1. **Google OAuth 回調頁面** - `auth-success.html`
2. **會員兌換課程碼** - `auth-client.js` 新增方法
3. **Dashboard 顯示課程** - `dashboard.html` 更新
4. **兌換頁面整合** - `unlock.html` 支援會員登入
5. **課程訪問控制** - `course-access.js` 支援 Session Token

---

## 🧪 測試流程

### 測試 1：Email 註冊與登入
**目標：** 驗證 Email 註冊、驗證、登入流程

**步驟：**
1. 打開 `login.html`
2. 切換到「註冊」標籤
3. 填寫資料：
   - 姓名：測試用戶
   - Email：test@example.com
   - 密碼：test123
4. 點擊「註冊」
5. 檢查 Email 收到驗證碼
6. 輸入驗證碼，點擊「驗證 Email」
7. 自動登入，跳轉到 Dashboard

**預期結果：**
- ✅ 註冊成功
- ✅ 收到驗證郵件
- ✅ 驗證成功
- ✅ 自動登入
- ✅ 跳轉到 Dashboard

---

### 測試 2：會員兌換課程碼
**目標：** 已登入用戶兌換課程碼

**前置條件：** 已完成測試 1，用戶已登入

**步驟：**
1. 在 Dashboard 點擊「兌換課程碼」
2. 輸入測試兌換碼：`APCS2024-DEMO01`
3. 點擊「解鎖課程」

**預期結果：**
- ✅ 兌換成功
- ✅ Dashboard 顯示「全部課程 (13)」
- ✅ 「我的課程」區塊顯示兌換記錄
- ✅ 顯示兌換日期和到期日期

---

### 測試 3：課程訪問權限
**目標：** 驗證已兌換用戶可以訪問付費課程

**前置條件：** 已完成測試 2，用戶已兌換課程

**步驟：**
1. 返回首頁 `index.html`
2. 嘗試訪問付費課程（如 B1, C1）
3. 檢查是否可以正常訪問

**預期結果：**
- ✅ 可以訪問所有課程
- ✅ 沒有顯示付費牆
- ✅ 課程內容正常顯示

---

### 測試 4：Google OAuth 登入
**目標：** 使用 Google 帳號登入

**前置條件：** 需要設置 Google OAuth 應用程式

**步驟：**
1. 打開 `login.html`
2. 點擊「使用 Google 登入」
3. 選擇 Google 帳號
4. 授權應用程式
5. 自動跳轉回 `auth-success.html`
6. 自動跳轉到 Dashboard

**預期結果：**
- ✅ Google 登入成功
- ✅ 自動創建用戶帳號
- ✅ 跳轉到 Dashboard
- ✅ 顯示 Google 頭像和姓名

---

### 測試 5：未登入用戶兌換（向後兼容）
**目標：** 驗證舊的兌換碼系統仍然可用

**前置條件：** 未登入狀態

**步驟：**
1. 登出（如果已登入）
2. 打開 `unlock.html`
3. 輸入兌換碼：`APCS2024-DEMO02`
4. 點擊「解鎖課程」

**預期結果：**
- ✅ 使用舊系統兌換成功
- ✅ 儲存 Access Token 到 localStorage
- ✅ 可以訪問付費課程

---

### 測試 6：Session 過期處理
**目標：** 驗證 Session 過期後的處理

**步驟：**
1. 登入後，手動刪除 localStorage 中的 `sessionToken`
2. 刷新 Dashboard 頁面
3. 嘗試訪問需要登入的功能

**預期結果：**
- ✅ 自動跳轉到登入頁面
- ✅ 提示「請重新登入」

---

### 測試 7：重複兌換防護
**目標：** 驗證同一用戶不能重複兌換同一個碼

**前置條件：** 已登入並兌換過一個課程碼

**步驟：**
1. 再次嘗試兌換相同的課程碼
2. 點擊「解鎖課程」

**預期結果：**
- ✅ 顯示錯誤訊息：「您已經兌換過此課程碼」
- ✅ 不會重複創建兌換記錄

---

## 🔧 部署前檢查清單

### 後端部署
- [ ] 更新 `auth-api.js` 到 Cloudflare Workers
- [ ] 確認 D1 數據庫已創建 `user_redemptions` 表
- [ ] 確認 KV 命名空間已綁定
- [ ] 設置環境變數：
  - [ ] `JWT_SECRET`
  - [ ] `RESEND_API_KEY`
  - [ ] `GOOGLE_CLIENT_ID`（如果使用 Google OAuth）
  - [ ] `GOOGLE_CLIENT_SECRET`（如果使用 Google OAuth）

### 前端部署
- [ ] 更新所有前端檔案到 Cloudflare Pages
- [ ] 確認 API_BASE_URL 指向正確的 Workers URL
- [ ] 測試所有頁面可以正常訪問

### 數據庫檢查
```sql
-- 檢查 user_redemptions 表是否存在
SELECT name FROM sqlite_master WHERE type='table' AND name='user_redemptions';

-- 檢查測試兌換碼
SELECT * FROM redemption_codes WHERE code LIKE 'APCS2024-DEMO%';

-- 檢查用戶數量
SELECT COUNT(*) FROM users;
```

---

## 🐛 常見問題排查

### 問題 1：兌換碼無效
**可能原因：**
- 兌換碼不存在於數據庫
- 兌換碼已被使用

**解決方法：**
```sql
-- 檢查兌換碼狀態
SELECT * FROM redemption_codes WHERE code = 'APCS2024-DEMO01';

-- 重置兌換碼（測試用）
UPDATE redemption_codes SET used = 0, used_at = NULL WHERE code = 'APCS2024-DEMO01';
```

### 問題 2：Session Token 無效
**可能原因：**
- Session 已過期
- KV 快取未同步

**解決方法：**
- 重新登入
- 檢查 KV 中的 session 記錄

### 問題 3：課程訪問被拒絕
**可能原因：**
- 用戶未兌換課程
- Session Token 未正確傳遞

**解決方法：**
- 檢查 localStorage 中的 `sessionToken`
- 檢查 API 請求是否包含 `sessionToken`
- 查看瀏覽器 Console 錯誤訊息

### 問題 4：Email 未收到
**可能原因：**
- Resend API Key 未設置
- Email 進入垃圾郵件

**解決方法：**
```bash
# 檢查 Resend API Key
wrangler secret list

# 查看 Worker 日誌
wrangler tail
```

---

## 📊 API 測試命令

### 測試會員兌換課程碼
```bash
curl -X POST https://apcs-auth-api.589411.workers.dev/api/auth/redeem-code \
  -H "Content-Type: application/json" \
  -d '{
    "code": "APCS2024-DEMO01",
    "sessionToken": "your-session-token"
  }'
```

### 測試查詢我的課程
```bash
curl -X GET https://apcs-auth-api.589411.workers.dev/api/auth/my-courses \
  -H "Authorization: Bearer your-session-token"
```

### 測試驗證 Session
```bash
curl -X POST https://apcs-auth-api.589411.workers.dev/api/auth/verify-session \
  -H "Content-Type: application/json" \
  -d '{
    "sessionToken": "your-session-token"
  }'
```

### 測試課程訪問權限
```bash
curl -X POST https://apcs-auth-api.589411.workers.dev/api/check-lesson \
  -H "Content-Type: application/json" \
  -d '{
    "lessonId": "B1",
    "sessionToken": "your-session-token"
  }'
```

---

## ✅ 完成標準

所有測試通過後，系統應該：
1. ✅ 支援 Email 註冊、驗證、登入
2. ✅ 支援 Google OAuth 登入
3. ✅ 會員可以兌換課程碼
4. ✅ Dashboard 顯示已兌換課程
5. ✅ 基於會員身份控制課程訪問
6. ✅ 向後兼容舊的兌換碼系統
7. ✅ Session 過期自動跳轉登入
8. ✅ 防止重複兌換

---

## 🚀 下一步

完成測試後，可以繼續實作：
1. **密碼重置功能**
2. **設備管理功能**
3. **用戶資料編輯**
4. **管理後台**
5. **Email 通知系統**

---

**測試完成日期：** _____________

**測試人員：** _____________

**測試結果：** ✅ 通過 / ❌ 失敗

**備註：**
